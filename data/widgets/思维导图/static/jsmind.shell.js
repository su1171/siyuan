(function($w){"use strict";var $d=$w.document;var __name__="jsMind";var jsMind=$w[__name__];if(!jsMind){return}if(typeof jsMind.shell!="undefined"){return}var options={play_delay:1000};jsMind.shell=function(jm){this.jm=jm;this.step=0;this.commands=[];this.delay_handle=0;this.playing=false;this.jm_editable=this.jm.get_editable()};jsMind.shell.prototype={init:function(){this.playing=false},record:function(action,obj){if(!this.playing){var command={action:action,data:obj.data,node:obj.node};var prev_command=this.commands[this.step-1];if(command.action==="update_node"&&prev_command.action==="add_node"&&prev_command.data[2]==="New Node"){prev_command.data[2]=command.data[1];this.commands[this.step-1]=prev_command}else{this.step=this.commands.push(command)}}},execute:function(command){var func=this.jm[command.action];var node=command.node;this.jm.enable_edit();func.apply(this.jm,command.data);this.jm.disable_edit();if(!!node){this.jm.select_node(node)}},add_command:function(command){this.commands.push(command);play()},replay:function(){this.step=0;this.play()},play:function(){this.jm.disable_edit();this.playing=true;this._play_stepbystep()},_play_stepbystep:function(){if(this.delay_handle!=0){$w.clearTimeout(this.delay_handle);this.delay_handle=0}if(this.step<this.commands.length){this.execute(this.commands[this.step]);this.step++;var js=this;this.delay_handle=$w.setTimeout(function(){js.play.call(js)},options.play_delay)}else{this._play_end()}},_play_end:function(){this.playing=false;if(this.jm_editable){this.jm.enable_edit()}else{this.jm.disable_edit()}},jm_event_handle:function(type,data){if(type===jsMind.event_type.show){this.record("show",data)}if(type===jsMind.event_type.edit){var action=data.evt;delete data.evt;this.record(action,data)}},};var shell_plugin=new jsMind.plugin("shell",function(jm){var js=new jsMind.shell(jm);jm.shell=js;js.init();jm.add_event_listener(function(type,data){js.jm_event_handle.call(js,type,data)})});jsMind.register_plugin(shell_plugin)})(window);let id="";let MessageBoxStatus=false;let messageBox=document.getElementById("messageBox");function showMessage(message){messageBox.innerText=message;messageBox.style.display="block";setTimeout(function(){messageBox.style.display="none"},1000)}async function request(url,data=null,method="POST"){return new Promise((resolve,reject)=>{if(method.toUpperCase()=="POST"){fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data),}).then((data)=>resolve(data.json()),(error)=>{alert("链接无效，即将刷新页面");parent.document.location.reload();reject(error)}).catch((err)=>{console.error("请求失败:",err)})}})}function saveDataToDoc(newData){const data=newData;const requestBody={attrs:{memo:data},id};request("/api/attr/setBlockAttrs",requestBody).then((data)=>{if(MessageBoxStatus){showMessage("已保存")}}).catch((err)=>{console.error(err)})}async function ImportData(){const response=await request("/api/attr/getBlockAttrs",{id});if(response.data["memo"]){return response.data["memo"]}else{return Promise.reject("数据初始化失败")}}try{var ifrs=parent.document.getElementsByTagName("iframe");for(var i=0;i<ifrs.length;i++){if(ifrs[i].contentWindow==window){var myIframe=ifrs[i];const currentBlock=myIframe.parentElement.parentElement;id=currentBlock.getAttribute("data-node-id")}}}catch(err){console.error(err)}var _jm=null;let mind;var options={container:"jsmind_container",editable:true,theme:"primary",view:{engine:"svg",hmargin:50,vmargin:50,line_width:2,line_color:"#b1c774",},layout:{hspace:40,vspace:10,pspace:13},shortcut:{handles:{},mapping:{addchild:9}},};function useDefaultSetting(){mind={meta:{name:"jsMind-demo-tree",author:"基于JSmind",version:"1"},format:"node_tree",data:{id:"root",topic:"主题",children:[{id:"easy",topic:"二级标题",direction:"left",expanded:true},{id:"open",topic:"二级标题",direction:"right",expanded:true},{id:"powerful",topic:"二级标题",direction:"right"},{id:"other",topic:"二级标题",direction:"left"},],},};_jm=jsMind.show(options,mind);let scaleNum=1;let jsmindInnerDom=_jm.view.e_panel;let timer=null;jsmindInnerDom.addEventListener("wheel",function(e){if(timer)return;timer=setTimeout(()=>{if(e.ctrlKey){scaleNum+=parseInt(e.deltaY/100)*0.1;if(scaleNum<=0.4){scaleNum=0.4}if(scaleNum>=2){scaleNum=2}jsmindInnerDom.style.transform=`scale(${scaleNum})`}timer=null},20)},false)}function load_jsmind(){ImportData().then((data)=>{if(data.length>0){try{data=data.replace(/&quot;/g,'"');data=data.replace(/&lt;/g,"<");data=data.replace(/&gt;/g,">");mind=JSON.parse(data);_jm=jsMind.show(options,mind);let scaleNum=1;let jsmindInnerDom=_jm.view.e_panel;let timer=null;jsmindInnerDom.addEventListener("wheel",function(e){if(timer)return;timer=setTimeout(()=>{if(e.ctrlKey){scaleNum+=parseInt(e.deltaY/100)*0.1;if(scaleNum<=0.4){scaleNum=0.4}if(scaleNum>=2){scaleNum=2}jsmindInnerDom.style.transform=`scale(${scaleNum})`}timer=null},20)},false)}catch(err){useDefaultSetting()}}else{useDefaultSetting()}},(err)=>{useDefaultSetting()}).catch((err)=>{console.error(err)})}function save_nodetree(){var mind_data=_jm.get_data("node_tree");dataStr=JSON.stringify(mind_data);saveDataToDoc(dataStr)}function handleSaveBtnClick(){MessageBoxStatus=true;save_nodetree();setTimeout(()=>{MessageBoxStatus=false},1100)}const saveBtn=document.getElementById("saveData");saveBtn.addEventListener("click",handleSaveBtnClick,false);load_jsmind();let keyword="";let allData=null;let allElementsArray=[];let targetArray=[];let resultPreviewDom=document.getElementById("resultPreview");let pathDom=document.getElementById("path");let searchingBtn=document.getElementById("searchingBtn");let submitBtn=document.getElementById("submitBtn");let searchListDom=document.getElementById("searchList");let keywordInput=document.getElementById("keywordInput");let containerDom=document.getElementById("container");let clearPathDom=document.getElementById("clearPath");containerDom.style.display="none";searchingBtn.addEventListener("click",function(){if(containerDom.style.display==="none"){containerDom.style.display="block"}else{containerDom.style.display="none"}if(!resultPreviewDom.innerText){resultPreviewDom.style.padding="0px"}},false);function collect(data){if(data.topic.trim()&&data.id){allElementsArray.push({topic:data.topic.trim(),id:data.id})}if(data.hasOwnProperty("children")){for(let i in data.children){collect(data.children[i])}}}function findTargetArray(keyword){ImportData().then((data)=>{if(!data.trim.length){try{data=data.replace(/&quot;/g,'"');data=data.replace(/&lt;/g,"<");data=data.replace(/&gt;/g,">");let res=JSON.parse(data);allData=res.data;collect(allData);targetArray=allElementsArray.filter((item,index,array)=>item.topic.includes(keyword));const frag=document.createDocumentFragment();for(let i of targetArray){const item=document.createElement("li");i.topic=i.topic.replace(/</g,"&lt;");i.topic=i.topic.replace(/>/g,"&gt;");const regExp=new RegExp(`${keyword}`,"g");i.topic=i.topic.replace(regExp,function(value){return`<span class="hightlight">${value}</span>`});item.innerHTML=i.topic;item.dataset.id=i.id;frag.appendChild(item)}searchListDom.appendChild(frag)}catch(err){}}},(err)=>{}).catch((err)=>{console.error(err)})}function handleKeywordSubmit(){searchListDom.innerHTML="";allElementsArray=[];targetArray=[];if(keywordInput.value.trim()){keyword=keywordInput.value.trim();findTargetArray(keyword)}}function handleListItemClick(e){if(resultPreviewDom.style.padding==="0px"){resultPreviewDom.style.padding="10px"}let nodePath="";let str="";if(e.target.nodeName==="LI"){const item_id=e.target.dataset.id;_jm.select_node(item_id);let currentNode=_jm.get_node(item_id);resultPreviewDom.innerHTML=currentNode.topic;str=currentNode.topic.replace(/</g,"&lt;");str.replace(/>/g,"&gt;");const regExp=new RegExp(`${keyword}`,"g");str=str.replace(regExp,function(value){return`<span class="hightlight">${value}</span>`});nodePath="/"+str+nodePath;while(currentNode.parent){currentNode=currentNode.parent;_jm.expand_node(currentNode);nodePath="/"+currentNode.topic+nodePath}pathDom.innerHTML=nodePath;clearPathDom.style.display="block"}else if(e.target.nodeName==="SPAN"&&e.target.parentNode.nodeName==="LI"){const item_id=e.target.parentNode.dataset.id;_jm.select_node(item_id);let currentNode=_jm.get_node(item_id);resultPreviewDom.innerHTML=currentNode.topic;str=currentNode.topic.replace(/</g,"&lt;");str.replace(/>/g,"&gt;");const regExp=new RegExp(`${keyword}`,"g");str=str.replace(regExp,function(value){return`<span class="hightlight">${value}</span>`});nodePath="/"+str+nodePath;while(currentNode.parent){currentNode=currentNode.parent;nodePath="/"+currentNode.topic+nodePath}pathDom.innerHTML=nodePath;clearPathDom.style.display="block"}}submitBtn.addEventListener("click",handleKeywordSubmit,false);keywordInput.addEventListener("keydown",(e)=>{if(e.key==="Enter"){handleKeywordSubmit()}},false);keywordInput.addEventListener("input",()=>{if(!keywordInput.value.trim()){searchListDom.innerHTML="";targetArray=[]}},false);searchListDom.addEventListener("click",handleListItemClick,false);pathDom.addEventListener("click",function(){if(containerDom.style.display==="block"){containerDom.style.display="none"}},false);clearPathDom.addEventListener("click",function(){pathDom.innerHTML="";clearPathDom.style.display="none"},false);let refreshBtn=document.getElementById("refresh");refreshBtn.addEventListener("click",()=>{window.location.reload()},false);const colorBox=document.getElementById("colorBox");const confirmBtn=document.getElementById("confirm");confirmBtn.addEventListener("click",()=>{let selectedNode=_jm.get_selected_node();if(selectedNode){_jm.set_node_color(selectedNode.id,colorBox.value,"#f4f4f4")}},false);document.addEventListener("keydown",(e)=>{if(e.altKey&&e.key==="x"){let selectedNode=_jm.get_selected_node();if(selectedNode){_jm.set_node_color(selectedNode.id,colorBox.value,"#f4f4f4")}}},false);